name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # 将 macos-latest 改为 macos-13 (Intel 架构)
        # ubuntu-latest 和 windows-latest 保持不变
        os: [windows-latest, macos-14, ubuntu-latest]

    steps:
      - name: 检出代码 (Checkout Code)
        uses: actions/checkout@v4

      - name: 安装 uv (Setup uv)
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: 设置 Python 环境
        run: uv python install 3.10

      - name: 安装项目依赖
        run: uv sync

      - name: 安装 Nuitka
        run: uv pip install Nuitka

      # --- Windows 构建 ---
      - name: 构建 Windows 版本
        if: matrix.os == 'windows-latest'
        run: |
          uv run python -m nuitka --assume-yes-for-downloads --standalone --onefile --enable-plugin=pyside6 --windows-console-mode=disable --windows-icon-from-ico=logo.ico --output-dir=build_out -o Global_Mouse_Win.exe main.py

      # --- macOS 构建 (DMG) ---
      - name: 构建 macOS 版本
        if: matrix.os == 'macos-14'
        run: |
          # 1. 强制指定架构为 x86_64，确保 Intel Mac 也能用
          # 如果你的测试机是 M1/M2，就把 x86_64 改成 arm64
          uv run python -m nuitka \
            --assume-yes-for-downloads \
            --standalone \
            --macos-create-app-bundle \
            --macos-target-arch=x86_64 \
            --enable-plugin=pyside6 \
            --macos-app-icon=logo.icns \
            --macos-app-name="Global Mouse" \
            --output-dir=build_out \
            main.py
          
          # 2. 重命名
          mv build_out/main.app "build_out/Global Mouse.app"
          
          # 3. 安装工具并打包
          brew install create-dmg
          create-dmg \
            --volname "Global Mouse Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Global Mouse.app" 175 120 \
            --hide-extension "Global Mouse.app" \
            --app-drop-link 425 120 \
            "Global_Mouse_Mac.dmg" \
            "build_out/Global Mouse.app/"
            
      # --- Linux 构建 (AppImage) ---
      - name: 构建 Linux 版本 (AppImage)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # 1. 安装构建依赖
          sudo apt-get update
          sudo apt-get install -y libfuse2t64 binutils
          
          # 2. 使用 Nuitka 编译 (注意：Nuitka 默认会生成 main.dist)
          uv run python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pyside6 --output-dir=build_out -o Global_Mouse_Linux main.py
          
          # 3. 准备 AppDir 结构
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # 【核心修复】：指向正确的 main.dist 目录
          cp -r build_out/main.dist/* AppDir/usr/bin/
          
          # 4. 创建桌面入口文件
          cat > AppDir/Global_Mouse.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Global Mouse
          Exec=Global_Mouse_Linux
          Icon=global_mouse
          Categories=Utility;
          EOF
          
          # 5. 准备图标 (尝试多种来源确保不报错)
          if [ -f "logo.png" ]; then
            cp logo.png AppDir/global_mouse.png
          elif [ -f "logo.ico" ]; then
            cp logo.ico AppDir/global_mouse.ico
          else
            # 如果都没有，随便造一个空文件防止打包失败
            touch AppDir/global_mouse.png
          fi
          
          # 6. 下载 appimagetool 并打包
          curl -Lo appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # 在 GitHub Actions (Ubuntu 24.04) 中运行 AppImage 工具需要加上 --appimage-extract-and-run
          ./appimagetool --appimage-extract-and-run AppDir Global_Mouse_Linux_x86.AppImage

      # --- 发布到 GitHub ---
      - name: 自动发布到 GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build_out/Global_Mouse_Win.exe
            Global_Mouse_Mac.dmg
            Global_Mouse_Linux_x86.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}